from flask import Flask, render_template, redirect,jsonify
import requests
import json
import pymongo
import mongo_dataloader
app = Flask(__name__)

conn = 'mongodb://localhost:27017'
client = pymongo.MongoClient(conn)
db = client.crime_db_3


#cloud
#conn=myconnection
#client = pymongo.MongoClient(conn)
#db = client.crime_db_4
npu_listings = list(db.npu.find())
cat_listings=list(db.cat.find())
data_listings=list(db.crime_info.find())
cat_neighborhood_listings=list(db.cat_neighborhood.find())
year_neighborhood_listings=list(db.year_neighborhood.find())


@app.route("/", methods=["GET"])
def home():
     return render_template("index.html")

@app.route("/neighborhood", methods=["GET"])
def mapping():
     return render_template("choropleth.html")


@app.route("/dashboard", methods=["GET"])
def dash():
     return render_template("cat_dashboard.html")

@app.route("/dash" , methods=["GET"])
def dashing():
     return render_template("dashboard.html")
@app.route("/map" , methods=["GET"])
def lalamap():
     return render_template("lalamap.html")




@app.route("/MapAPI", methods=["GET"])
def MapAPI():
    db=client.crime_db_npu
    mongo_dataloader.data_loading(csv="ETL/resources/year_map.csv",db=client.crime_npu)
    npu_listings = list(db.collection.find())
    res=[]
    for listing in npu_listings:
        res.append({ 'npu': listing["npu"],  
        'occur_year': listing["occur_year"], 
        'occur_count': listing["occur_count"]})
    return jsonify(res=res)


@app.route("/cat_neighborhood", methods=["GET"])
def cat_neighborhood():
    db=client.crime_neighb_cat
    mongo_dataloader.data_loading(csv="ETL/resources/neighborhood_cat.csv",db=client.crime_neighb_cat)
    cat_neighborhood_listings = list(db.collection.find())
    res=[]
    for listing in cat_neighborhood_listings:
        res.append({
        'neighborhood': listing["neighborhood"],
        'crime_type': listing["crime_type"],
        'occur_year': listing["occur_year"],
        'occur_month':listing["occur_month"],
        'occur_count': listing["occur_count"]})
    return jsonify(res=res)


@app.route("/year_neighborhood", methods=["GET"])
def year_neighborhood():
    db=client.crime_neighb_year
    mongo_dataloader.data_loading(csv="ETL/resources/neighborhood_year.csv",db=client.crime_neighb_year)
    year_neighborhood_listings = list(db.collection.find())
    res=[]
    for listing in year_neighborhood_listings:
        res.append({
         'neighborhood': listing["neighborhood"],
        'occur_year': listing["occur_year"],
        'occur_count': listing["occur_count"]})
    return jsonify(res=res)


@app.route("/catAPI", methods=["GET"])
def catAPI():
    db=client.crime_db_npu_cat
    mongo_dataloader.data_loading(csv="ETL/resources/year_map_cat.csv",db=client.crime_db_npu_cat)
    cat_listings = list(db.collection.find())
    res=[]
    for listing in cat_listings:
        # del listing['_id']
        res.append({ 'npu': listing["npu"],
        'crime_type': listing["crime_type"],
        'occur_year': listing["occur_year"],
        'occur_month':listing["occur_month"],
        'occur_count': listing["occur_count"]})
    return jsonify(res=res)


if __name__ == '__main__':
    app.run(debug=True)
